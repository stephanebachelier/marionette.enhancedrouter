<!DOCTYPE html><html lang="en"><head><title>lib/marionette.enhancedrouter</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/marionette.enhancedrouter"><meta name="groc-project-path" content="lib/marionette.enhancedrouter.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/marionette.enhancedrouter.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="enhancedrouter">EnhancedRouter</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This router is called EnhancedRouter because it adds logic on top of <code>Backbone.Router</code>.
It is heavily inspired by the <code>Marionette.AppRouter</code> but it adds some interesting options:
* can have multiple controllers, one for each route, or a <em>global</em> controller. The router
can be itself a controller.
* getting a controller is delegated to resolving a promise. The idea behind this is to have
the ability to lazy start an application when a route handler is triggered.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">EnhancedRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>call setup() if a trueable <code>setup</code> property exists in options</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">setup</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setup</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="setup">setup</h2>

<p>setup routes defined in appRoutes which enable the
initialization of routes after the addition of some event
listeners.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processAppRoutes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getOption</span><span class="p">(</span><span class="s1">&#39;appRoutes&#39;</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>trigger a <code>router:start</code> when the first route is activated</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;router:start&#39;</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">splice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_processOnRoute</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-processonroute">_processOnRoute</h2>

<p>process the route event and trigger the onRoute
method call, if it exists</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_processOnRoute</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">routeName</span><span class="p">,</span> <span class="nx">routeArgs</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>find the path that matched the route</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">routePath</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">appRoutes</span><span class="p">)[</span><span class="nx">routeName</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>make sure an onRoute is there, and call it</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onRoute</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onRoute</span><span class="p">(</span><span class="nx">routeName</span><span class="p">,</span> <span class="nx">routePath</span><span class="p">,</span> <span class="nx">routeArgs</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="processapproutes">processAppRoutes</h2>

<p>Internal method to process the <code>appRoutes</code> for the
router, and turn them in to routes that trigger the
specified method on a <code>controller</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">processAppRoutes</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">appRoutes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">appRoutes</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Backbone requires reverted order of routes</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">routeNames</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">appRoutes</span><span class="p">).</span><span class="nx">reverse</span><span class="p">();</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">routeNames</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_addAppRoute</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">appRoutes</span><span class="p">[</span><span class="nx">route</span><span class="p">]);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-getcontroller">_getController</h2>

<p>find a controller for the given <code>route</code>
also pass a resolve and reject function</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_getController</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>resolve promise if controller is present for current route</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">controller</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>record resolve and reject function for later use for the given route</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="o">:</span> <span class="nx">resolve</span><span class="p">,</span>
        <span class="nx">reject</span><span class="o">:</span> <span class="nx">reject</span>
      <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if catch all router exists</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">resolve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">].</span><span class="nx">controller</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="addcontroller">addController</h2>

<p>Add a <code>controller</code> to delegate the logic for the given <code>route</code>
or add a <em>global</em> controller by calling without giving a route
<code>router.addController(Controller)</code></p></div></div><div class="code"><div class="wrapper">  <span class="nx">addController</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add catch all route</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">route</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">route</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add the <code>controller</code> under the <code>route</code> entry on <code>_controllers</code></p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">controller</span><span class="o">:</span> <span class="nx">controller</span>
      <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add or update the current <code>controller</code> for the given <code>route</code></p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>resolve promise if a resolver exists for the given <code>route</code></p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_controllers</span><span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">controller</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-addapproute">_addAppRoute</h2>

<p>this method is responsible for adding handlers for the given <code>route</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_addAppRoute</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>trigger the <code>before:route</code></p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">triggerMethod</span><span class="p">(</span><span class="s1">&#39;before:route&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>

      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>build a promise to wait for controller being defined</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RSVP</span><span class="p">.</span><span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_getController</span><span class="p">,</span> <span class="nx">self</span><span class="p">)(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>find a the method <code>methodName</code> on the <code>controller</code>.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">[</span><span class="nx">methodName</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Method &quot;&#39;</span> <span class="o">+</span> <span class="nx">methodName</span> <span class="o">+</span> <span class="s1">&#39;&quot; was not found on the controller&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">handler</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>trigger the <code>after:route</code></p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">triggerMethod</span><span class="p">(</span><span class="s1">&#39;after:route&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">route</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
      <span class="p">});</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add a handler for the given <code>route</code></p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="helpers-methods">Helpers methods</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Proxy <code>getOption</code> to enable getting options from this or this.options by name.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">getOption</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">optionName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">getOption</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">optionName</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>borrow the <code>triggerMethod</code> from Marionette</p></div></div><div class="code"><div class="wrapper">  <span class="nx">triggerMethod</span><span class="o">:</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">triggerMethod</span>
<span class="p">});</span>

<span class="nx">Backbone</span><span class="p">.</span><span class="nx">EnhancedRouter</span> <span class="o">=</span> <span class="nx">EnhancedRouter</span><span class="p">;</span></div></div></div></div></body></html>