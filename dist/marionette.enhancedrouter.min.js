/*! marionette.enhancedrouter - v1.4.0
 *  Release on: 2014-08-19
 *  Copyright (c) 2014 StÃ©phane Bachelier
 *  Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["backbone","marionette","underscore","rsvp"],function(c,d,e,f){return a.returnExportsGlobal=b(c,d,e,f)}):"object"==typeof exports?module.exports=b(require("backbone"),require("marionette"),require("underscore"),require("rsvp")):a.EnhancedRouter=b(backbone,marionette,_,RSVP)}(this,function(a,b,c,d){"use strict";var e=a.Router.extend({constructor:function(b){a.Router.apply(this,arguments),this.options=b||{},this._controllers={},this.options.controller&&this.addController(this.options.controller),this.options.setup&&this.options.setup===!1||this.setup()},setup:function(){this.processAppRoutes(this.getOption("appRoutes")),this.once("route",function(){this.trigger("router:start",Array.prototype.splice.call(arguments,0))}),this.on("route",this._processOnRoute,this)},_processOnRoute:function(a,b){var d=c.invert(this.appRoutes)[a];c.isFunction(this.onRoute)&&this.onRoute(a,d,b)},processAppRoutes:function(a){if(a){var b=c.keys(a).reverse();c.each(b,function(b){this._addAppRoute(b,a[b])},this)}},_getController:function(a,b,c){this._addRouteResolver(a,b,c),this.resolveRoute(a)},addController:function(a,b){if(b=b||"*","string"==typeof b)this.addRouteController(a,b);else if("[object Array]"===Object.prototype.toString.call(b))for(var c=0,d=b.length;d>c;c+=1)this.addRouteController(a,b[c]);else for(var e in b)this.addRouteController(a,e)},addRouteController:function(a,b){this._controllers[b]||(this._controllers[b]={}),this._controllers[b].controller=a},resolveRoute:function(a){this._resolveRoute(a)||this._resolveCatchAllRoute()},_resolveRoute:function(a){var b=this._isRouteDefined(a);return b&&this._controllers[a].resolve(this._controllers[a].controller),b},_resolveCatchAllRoute:function(){this._hasRouteController("*")&&this.currentResolver&&this.currentResolver.resolve(this._controllers["*"].controller)},_addRouteResolver:function(a,b,c){this._controllers[a]||(this._controllers[a]={}),this._controllers[a].resolve=b,this._controllers[a].reject=c,this.currentResolver={resolve:b,reject:c}},_isRouteDefined:function(a){return this._hasRouteResolver(a)&&this._hasRouteController(a)},_hasRouteResolver:function(a){return void 0!==this._controllers[a]&&void 0!==this._controllers[a].resolve},_hasRouteController:function(a){return void 0!==this._controllers[a]&&void 0!==this._controllers[a].controller},_addAppRoute:function(a,b){var e=function(){var e={route:a,params:arguments};this.triggerMethod("before:route",e);var f=this,g=new d.Promise(function(b,d){c.bind(f._getController,f)(a,b,d)});g.then(function(a){var c=a[b];if(!c)throw new Error('Method "'+b+'" was not found on the controller');c&&c.apply(a,e.params),f.triggerMethod("after:route",e)}).catch(function(a){f.errorHandler.call(f,a)})};this.route(a,b,c.bind(e,this))},errorHandler:function(a){console.log(a.stack)},getOption:function(a){return b.getOption(this,a)},triggerMethod:b.triggerMethod});return a.EnhancedRouter=e,e});