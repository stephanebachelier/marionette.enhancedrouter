/*! marionette.enhancedrouter - v1.5.4
 *  Release on: 2015-11-10
 *  Copyright (c) 2015 StÃ©phane Bachelier
 *  Licensed MIT */
!function(a,b){"object"==typeof exports?module.exports=b(require("backbone"),require("marionette"),require("underscore"),require("rsvp")):"function"==typeof define&&define.amd?define(["backbone","marionette","underscore","rsvp"],b):a.EnhancedRouter=b(a.backbone,a.marionette,a._,a.RSVP)}(this,function(a,b,c,d){"use strict";var e=a.Router.extend({constructor:function(b){a.Router.apply(this,arguments),this.options=b||{},this._controllers={},this.options.controller&&this.addController(this.options.controller),this.options.setup&&this.options.setup===!1||this.setup()},setup:function(){this.processAppRoutes(this.getOption("appRoutes")),this.once("route",function(){this.trigger("router:start",Array.prototype.splice.call(arguments,0))}),this.on("route",this._processOnRoute,this)},_processOnRoute:function(a,b){var d=c.invert(this.appRoutes)[a];c.isFunction(this.onRoute)&&this.onRoute(a,d,b)},processAppRoutes:function(a){if(a){var b=c.keys(a).reverse();c.each(b,function(b){this._addAppRoute(b,a[b])},this)}},_getController:function(a,b,c){this._addRouteResolver(a,b,c),this.resolveRoute(a)},addController:function(a,b){if(b=b||"*","string"==typeof b)this.addRouteController(a,b);else if("[object Array]"===Object.prototype.toString.call(b))for(var c=0,d=b.length;d>c;c+=1)this.addRouteController(a,b[c]);else for(var e in b)this.addRouteController(a,e)},addRouteController:function(a,b){this._controllers[b]=a,this._resolveRoute(b)},resolveRoute:function(a){this._resolveRoute(a)||this._resolveCatchAllRoute()},_resolveRoute:function(a){var b=this._hasRouteController(a)&&this._pending;return b&&this._resolvePending(a),b},_resolveCatchAllRoute:function(){this._resolveRoute("*")},_resolvePending:function(a){this._pending.resolve(this._controllers[a]),delete this._pending},_addRouteResolver:function(a,b,c){this._pending={route:a,resolve:b,reject:c}},_hasRouteController:function(a){return void 0!==this._controllers[a]},_addAppRoute:function(a,b){var d=function(){var d={route:a,params:arguments};this.triggerMethod("before:route",d);var e=this,f=new Promise(function(b,d){c.bind(e._getController,e)(a,b,d)});f.then(function(a){var c=a[b];if(!c)throw new Error('Method "'+b+'" was not found on the controller');c&&c.apply(a,d.params),e.triggerMethod("after:route",d)})["catch"](function(a){e.errorHandler.call(e,a)})};this.route(a,b,c.bind(d,this))},errorHandler:function(a){console.log(a.stack)},getOption:function(a){return b.getOption(this,a)},triggerMethod:b.triggerMethod});return a.EnhancedRouter=e,e});