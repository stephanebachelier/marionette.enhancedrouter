/*! marionette.enhancedrouter - v1.2.1
 *  Release on: 2014-08-04
 *  Copyright (c) 2014 St√©phane Bachelier
 *  Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["backbone","marionette","underscore","rsvp"],function(c,d,e,f){return a.returnExportsGlobal=b(c,d,e,f)}):"object"==typeof exports?module.exports=b(require("backbone"),require("marionette"),require("underscore"),require("rsvp")):a.EnhancedRouter=b(backbone,marionette,_,RSVP)}(this,function(a,b,c,d){"use strict";var e=a.Router.extend({constructor:function(b){a.Router.apply(this,arguments),this.options=b||{},this._controllers={},this.options.controller&&this.addController(this.options.controller),this.options.setup&&this.options.setup===!1||this.setup()},setup:function(){this.processAppRoutes(this.getOption("appRoutes")),this.once("route",function(){this.trigger("router:start",Array.prototype.splice.call(arguments,0))}),this.on("route",this._processOnRoute,this)},_processOnRoute:function(a,b){var d=c.invert(this.appRoutes)[a];c.isFunction(this.onRoute)&&this.onRoute(a,d,b)},processAppRoutes:function(a){if(a){var b=c.keys(a).reverse();c.each(b,function(b){this._addAppRoute(b,a[b])},this)}},_getController:function(a,b,c){var d=a.route;this._controllers[d]&&this._controllers[d].controller?b(a.params):(this._controllers[d]={resolve:b,reject:c},this._controllers["*"]&&this._controllers[d].resolve(a.params))},addController:function(a,b){void 0===b&&(b="*"),this._controllers[b]?(this._controllers[b].controller=a,this._controllers[b].resolve&&this._controllers[b].resolve(a)):this._controllers[b]={controller:a}},_addAppRoute:function(a,b){var e=function(){var e={route:a,params:arguments};this.triggerMethod("before:route",e);var f=this,g=new d.Promise(function(a,b){c.bind(f._getController,f)(e,a,b)});g.then(function(c){var d=c[b];if(!d)throw new Error('Method "'+b+'" was not found on the controller');d&&d.apply(c,arguments),f.triggerMethod("after:route",[a].concat(arguments))})};this.route(a,b,c.bind(e,this))},getOption:function(a){return b.getOption(this,a)},triggerMethod:b.triggerMethod});return a.EnhancedRouter=e,e});